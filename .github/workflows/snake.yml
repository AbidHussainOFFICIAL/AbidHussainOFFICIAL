name: Generate Snake & Update README

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # runs daily

# üîê REQUIRED PERMISSIONS
permissions:
  contents: write

jobs:
  snake:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository (MANDATORY)
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Generate snake GIFs
      - name: Generate snake animation
        uses: Platane/snk@v3
        with:
          github_user_name: AbidHussainOFFICIAL
          outputs: |
            dist/ocean-light.gif
            dist/ocean-dark.gif?palette=github-dark

      # 3Ô∏è‚É£ Push GIFs to gh-pages (auto-creates branch)
      - name: Deploy snake GIFs to GitHub Pages
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: gh-pages
          build_dir: dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 4Ô∏è‚É£ Update README with theme-aware Snake GIF
      - name: Update README with theme-aware Snake GIF
        shell: bash
        run: |
          set -euo pipefail

          REPO_NAME="${GITHUB_REPOSITORY##*/}"
          USER_NAME="${GITHUB_REPOSITORY_OWNER}"

          LIGHT_GIF_URL="https://${USER_NAME}.github.io/${REPO_NAME}/ocean-light.gif"
          DARK_GIF_URL="https://${USER_NAME}.github.io/${REPO_NAME}/ocean-dark.gif"

          README_FILE="README.md"

          # Ensure README exists
          [ -f "$README_FILE" ] || echo "# ${USER_NAME}" > "$README_FILE"

          # Build snake section
          read -r -d '' GIF_SECTION <<EOF || true
<!-- SNAKE_GIF -->
<div align="center">
  <h3>üêç GitHub Snake Animation</h3>
  <p>Watch my GitHub contributions come alive!</p>
  <picture>
    <source srcset="${DARK_GIF_URL}" media="(prefers-color-scheme: dark)">
    <img src="${LIGHT_GIF_URL}" alt="GitHub Snake" style="max-width:480px;width:100%;" />
  </picture>
</div>
EOF

          # Remove old snake section if exists
          sed -i.bak '/<!-- SNAKE_GIF -->/,/<\/div>/d' "$README_FILE" || true
          rm -f README.md.bak

          # Prepend new snake section
          printf "%s\n\n%s\n" "$GIF_SECTION" "$(cat "$README_FILE")" > README.tmp
          mv README.tmp "$README_FILE"

          # Commit only if README changed
          if git diff --quiet; then
            echo "No README changes detected"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "chore: update README snake animation"
          git push origin main
